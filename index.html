<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Object Interaction</title>
  <script type="module">
    import { WebXRButton } from './js/util/webxr-button.js';
    import { Scene } from './js/render/scenes/scene.js';
    import { Renderer, createWebGLContext } from './js/render/core/renderer.js';
    import { Node } from './js/render/core/node.js';
    import { Gltf2Node } from './js/render/nodes/gltf2.js';
    import { DropShadowNode } from './js/render/nodes/drop-shadow.js';
    import { vec3, mat4 } from './js/render/math/gl-matrix.js';
    import { UrlTexture } from './js/render/core/texture.js';
    import { ButtonNode } from './js/render/nodes/button.js';

    let xrButton = null;
    let xrRefSpace = null;
    let xrHitTestSource = null;
    let gl = null;
    let renderer = null;
    let scene = new Scene();
    scene.enableStats(false);

    let arObject = new Node();
    arObject.visible = false;
    scene.addNode(arObject);

    let video = document.createElement('video');
    video.src = 'media/video/Demowebm.webm';
    video.loop = true;
    video.muted = false;
    video.playsInline = true;
    video.style.display = 'none';
    document.body.appendChild(video);

    let playTexture = new UrlTexture('media/textures/play-button.png');
    let playButton = new ButtonNode(playTexture, () => {
      if (video.paused) {
        video.play();
        playButton.visible = false;
      }
    });
    playButton.translation = [0, 0.5, -1.5];
    playButton.scale = [0.5, 0.5, 0.5];
    scene.addNode(playButton);

    function initXR() {
      xrButton = new WebXRButton({
        onRequestSession: onRequestSession,
        onEndSession: onEndSession,
      });
      document.querySelector('header').appendChild(xrButton.domElement);

      if (navigator.xr) {
        navigator.xr.isSessionSupported('immersive-ar')
          .then(supported => xrButton.enabled = supported);
      }
    }

    function onRequestSession() {
      return navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['local', 'hit-test'] })
        .then(session => {
          xrButton.setSession(session);
          session.requestReferenceSpace('local').then(refSpace => {
            xrRefSpace = refSpace;
            session.requestAnimationFrame(onXRFrame);
          });
        });
    }

    function onXRFrame(t, frame) {
      let session = frame.session;
      let pose = frame.getViewerPose(xrRefSpace);
      scene.startFrame();
      session.requestAnimationFrame(onXRFrame);
      scene.drawXRFrame(frame, pose);
      scene.endFrame();
    }

    initXR();
  </script>
</head>
<body>
  <header></header>
</body>
</html>
